clc
clear
close all
 
filename = 'wefoundloveshort.m4a';
 
%read in audio file-----------------
[X, fs] = audioread(filename);
X = X(:,1);
N = length(X);
t = (0:N-1)/fs;
%-----------------------------------
 
 
%plot in frequency domain-----------
DFT = fft(X);
DFT = abs(dataFlip(DFT));
freq = 1:N;
% figure(1);
% plot(freq, DFT); xlabel('Frequency'); ylabel('Magnitude'); title('Original signal');
%-----------------------------------
 
 
%create and apply butterworth filter----------
% fc_low = 200;
% %low cutoff frequency to isolate bass
% 
% figure(2);
% [b, a] = butter(6,fc_low/(fs/2));
% freqz(b,a);
% 
% filteredBass = filter(b, a, X);
% %---------------------------------------------
% 
% 
% %plot filtered signal in frequency domain-----
% DFT_filtered = fft(filteredBass);
% DFT_filtered = abs(dataFlip(DFT_filtered));
% figure(3);
% plot(freq, DFT_filtered); xlabel('Frequency'); ylabel('Magnitude'); title('Lowpass filter');
% %---------------------------------------------
 
%create and apply butterworth filter----------
fc_high = 300;
%high cutoff frequency to isolate melody
 
figure(4);
[b2, a2] = butter(9,fc_high/(fs/2), 'low');
freqz(b2,a2);
filteredBass = filter(b2, a2, X);
%---------------------------------------------
 
 
%plot filtered signal in frequency domain-----
% DFT_filtered2 = fft(filteredMelody);
% DFT_filtered2 = abs(dataFlip(DFT_filtered2));
 
 
%sound(filteredBass,fs);
figure(5);
x1 = fft(filteredBass);
dt1 = 1/fs;
df1 = fs/length(filteredBass);
time1 = 0:dt1:(length(filteredBass)*dt1)-dt1;
plot(time1,abs(filteredBass));
absBass = abs(filteredBass);
bassVal = absBass./.2.*255;
m = max(bassVal);
figure(6);
bassVal(bassVal > 255) = 255;


plot(time1,bassVal);
%a = arduino();
normV = bassVal;
Twin = 0.1;

TwinIn = Twin/dt1;
p = length(normV)./TwinIn;
voltages = zeros(1,round(p)-150);
for i=1:length(voltages)-150;
    voltages(i) = normV(i*round(TwinIn));
end
writematrix(voltages,'v.txt');
% a = arduino();
% sound(X,fs);
% for c = 1:length(voltages)
%     v = voltages(c);
%     writePWMVoltage(a,'D3',v);
%     pause(Twin);
%     %writePWMVoltage(a,'D3',0);
% 
% end

vals = round(voltages);
freqs = round([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,18.841552734375,3383.40454101562,697.137451171875,1257.00073242188,425.28076171875,928.619384765625,1391.58325195312,858.636474609375,1399.658203125,925.927734375,371.44775390625,368.756103515625,737.51220703125,1886.84692382812,366.064453125,355.2978515625,368.756103515625,314.923095703125,702.520751953125,699.8291015625,341.839599609375,368.756103515625,371.44775390625,1480.40771484375,1106.26831054688,1119.7265625,1073.96850585938,1103.57666015625,826.336669921875,1108.9599609375,1114.34326171875,1108.9599609375,1076.66015625,1108.9599609375,1117.03491210938,1084.73510742188,1108.9599609375,721.3623046875,1103.57666015625,885.552978515625,1248.92578125,1265.07568359375,931.31103515625,11046.533203125,425.28076171875,934.002685546875,925.927734375,406.439208984375,368.756103515625,371.44775390625,740.203857421875,368.756103515625,368.756103515625,366.064453125,896.319580078125,944.769287109375,985.14404296875,987.835693359375,987.835693359375,987.835693359375,990.52734375,839.794921875,842.486572265625,934.002685546875,939.385986328125,985.14404296875,987.835693359375,855.94482421875,742.8955078125,1483.09936523438,1472.33276367188,1114.34326171875,742.8955078125,1108.9599609375,1117.03491210938,1477.71606445312,1108.9599609375,748.27880859375,831.719970703125,465.655517578125,462.9638671875,473.73046875,909.77783203125,934.002685546875,893.6279296875,1849.16381835938,271.856689453125,740.203857421875,742.8955078125,1082.04345703125,1111.65161132812,258.3984375,1246.23413085938,1402.34985351562,1047.05200195312,1041.66870117188,368.756103515625,1254.30908203125,360.68115234375,1100.88500976562,1491.17431640625,1108.9599609375,1466.94946289062,419.8974609375,1485.791015625,1483.09936523438,1114.34326171875,734.820556640625,417.205810546875,1496.5576171875,1090.11840820312,734.820556640625,732.12890625,1472.33276367188,253.01513671875,831.719970703125,831.719970703125,462.9638671875,460.272216796875,823.64501953125,890.936279296875,931.31103515625,934.002685546875,934.002685546875,847.869873046875,368.756103515625,374.139404296875,1100.88500976562,931.31103515625,874.786376953125,936.6943359375,1485.791015625,1483.09936523438,987.835693359375,1483.09936523438,947.4609375,880.169677734375,931.31103515625,928.619384765625,931.31103515625,920.54443359375,371.44775390625,368.756103515625,1857.23876953125,1103.57666015625,1103.57666015625,1491.17431640625,1100.88500976562,1111.65161132812,1103.57666015625,1117.03491210938,1472.33276367188,1119.7265625,1103.57666015625,1117.03491210938,1106.26831054688,1119.7265625,1475.0244140625,1111.65161132812,1111.65161132812,1477.71606445312,1082.04345703125,1243.54248046875,1246.23413085938,944.769287109375,934.002685546875,939.385986328125,944.769287109375,923.236083984375,939.385986328125,939.385986328125,934.002685546875,942.07763671875,934.002685546875,925.927734375,944.769287109375,920.54443359375,942.07763671875,944.769287109375,917.852783203125,947.4609375,915.1611328125,925.927734375,1106.26831054688,557.171630859375,1108.9599609375,1106.26831054688,1095.50170898438,2473.62670898438,2462.86010742188,1475.0244140625,1485.791015625,476.422119140625,993.218994140625,1480.40771484375,417.205810546875,939.385986328125,925.927734375,829.0283203125,414.51416015625,837.103271484375,820.953369140625,419.8974609375,406.439208984375,845.17822265625,952.84423828125,985.14404296875,987.835693359375,987.835693359375,842.486572265625,934.002685546875,985.14404296875,928.619384765625,368.756103515625,826.336669921875,2188.31176757812,366.064453125,263.78173828125,371.44775390625,368.756103515625,368.756103515625,368.756103515625,368.756103515625,1849.16381835938,1114.34326171875,1106.26831054688,1125.10986328125,1092.81005859375,1117.03491210938,1100.88500976562,1117.03491210938,1475.0244140625,1111.65161132812,1108.9599609375,1111.65161132812,1480.40771484375,1076.66015625,1246.23413085938,1246.23413085938,939.385986328125,939.385986328125,928.619384765625,944.769287109375,915.1611328125,985.14404296875,955.535888671875,923.236083984375,944.769287109375,473.73046875,917.852783203125,960.919189453125,928.619384765625,917.852783203125,939.385986328125,912.469482421875,777.886962890625,829.0283203125,847.869873046875,1041.66870117188,1009.36889648438,1117.03491210938,1100.88500976562,1082.04345703125,987.835693359375,987.835693359375,990.52734375,492.572021484375,912.469482421875,931.31103515625,920.54443359375,931.31103515625,925.927734375,839.794921875,936.6943359375,753.662109375,734.820556640625,748.27880859375,1100.88500976562,734.820556640625,748.27880859375,737.51220703125,745.587158203125,371.44775390625,366.064453125,740.203857421875,745.587158203125,732.12890625,753.662109375,740.203857421875,734.820556640625,748.27880859375,366.064453125,740.203857421875,748.27880859375,734.820556640625,748.27880859375,371.44775390625,1889.53857421875,748.27880859375,339.14794921875,939.385986328125,446.81396484375,934.002685546875,1405.04150390625,1396.96655273438,934.002685546875,465.655517578125,936.6943359375,931.31103515625,842.486572265625,664.837646484375,1862.6220703125,734.820556640625,366.064453125,1485.791015625,293.389892578125,581.396484375,629.84619140625,1049.74365234375,1049.74365234375,1044.3603515625,737.51220703125,1052.43530273438,697.137451171875,737.51220703125,1870.69702148438,718.670654296875,737.51220703125,847.869873046875,411.822509765625,750.970458984375,740.203857421875,734.820556640625,740.203857421875,411.822509765625,742.8955078125,740.203857421875,417.205810546875,473.73046875,465.655517578125,934.002685546875,931.31103515625,928.619384765625,928.619384765625,934.002685546875,1870.69702148438,931.31103515625,923.236083984375,1396.96655273438,737.51220703125,1851.85546875,1843.78051757812,1108.9599609375,314.923095703125,928.619384765625,952.84423828125,987.835693359375,987.835693359375,985.14404296875,985.14404296875,987.835693359375,845.17822265625,837.103271484375,928.619384765625,934.002685546875,928.619384765625,834.41162109375,368.756103515625,734.820556640625,745.587158203125,729.437255859375,748.27880859375,374.139404296875,737.51220703125,737.51220703125,468.34716796875,737.51220703125,1857.23876953125,1402.34985351562,1396.96655273438,1399.658203125,1396.96655273438,936.6943359375,931.31103515625,934.002685546875,928.619384765625,928.619384765625,740.203857421875,1841.0888671875,1111.65161132812,317.61474609375,936.6943359375,1243.54248046875,697.137451171875,1399.658203125,1402.34985351562,737.51220703125,645.99609375,697.137451171875,1846.47216796875,748.27880859375,715.97900390625,737.51220703125,419.8974609375,409.130859375,745.587158203125,742.8955078125,1103.57666015625,740.203857421875,732.12890625,740.203857421875,740.203857421875,438.739013671875,446.81396484375]);

writematrix(vals,'vals.txt');
writematrix(freqs,'freqs.txt');



 
% [pks, locs] = findpeaks(filteredBass,time1,'MinPeakProminence',40);
% peakInterval = diff(locs);
% histogram(peakInterval)
% xlabel('Year Intervals')
% ylabel('Frequency of Occurrence')
% title('Histogram of Peak Intervals (years)')
 
 
 
 
 
% Twin = 1;
% Nwin = round(fs*Twin);
% ovrlp = 0;
% win = hamming(Nwin);
% nxtPwr = ceil(log10(Nwin)/log10(2))+1;
% Nfft = 2^(nxtPwr);
% [s,w,t] = spectrogram(filteredBass, win, ovrlp, Nfft, fs, 'yaxis', 'psd');
% spectrogram(filteredBass, win, ovrlp, Nfft, fs, 'yaxis', 'psd');
% 
% [~, loc] = max(s);
% guesses = (loc - 1) * fs / Nfft;
% 
% gleg = length(guesses);
% glegmax = max(guesses);